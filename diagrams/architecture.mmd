%% Secure RAG Pipeline Architecture - Optimized Layout
graph TD

  %% Define Styles
  classDef external fill:#f9f9f9,stroke:#333,stroke-width:2px;
  classDef api fill:#e6f3ff,stroke:#0066cc,stroke-width:2px;
  classDef security fill:#fff0e6,stroke:#ff6600,stroke-width:2px;
  classDef data fill:#e6ffe6,stroke:#009900,stroke-width:2px;
  classDef llm fill:#f2e6ff,stroke:#6600cc,stroke-width:2px;
  classDef obs fill:#fffbe6,stroke:#cccc00,stroke-width:2px;

  %% Zones
  subgraph EXT [External Zone - Untrusted]
    direction LR
    USER([User / Client App]):::external
    ADMIN([Admin / Ingest Client]):::external
  end

  subgraph API_BOUNDARY [API Boundary - FastAPI]
    direction TB
    GW[API Gateway Routes<br/>/chat | /ingest]:::api
    
    subgraph SECURITY_GATE [Security Enforcement]
        direction LR
        AUTHN[AuthN: JWT Validation]:::security
        AUTHZ[AuthZ: Tenant Policy Guard]:::security
        REDACT[PII Redactor]:::security
    end
    
    RAG[RAG Orchestrator]:::api
    
    subgraph CONTENT_DEFENSE [Content Defense]
        direction LR
        FILTERS[Injection Filters]:::security
        PROMPT[Prompt Assembler<br/>+ Citations]:::security
    end
  end

  subgraph DATA_PLANE [Data Plane - Isolated]
    direction LR
    VS[(Vector Store<br/>Qdrant)]:::data
    MS[(Metadata Store<br/>Tenant ID)]:::data
  end

  subgraph MODEL [Model Boundary - Secure]
    LLM[[Local LLM Engine]]:::llm
  end

  subgraph OBS [Observability]
    LOGS{Structured Logs<br/>Redacted}:::obs
  end

  %% --- Relationships and Flow ---

  %% User Flow
  USER -- POST /chat --> GW
  ADMIN -- POST /ingest --> GW

  %% API Processing
  GW --> AUTHN
  AUTHN --> AUTHZ
  AUTHZ -- Allow --> RAG
  AUTHZ -- Deny --> USER

  %% RAG Orchestration (Retrieval)
  RAG -- Tenant-bound query --> VS
  RAG -. Lookup .-> MS
  
  %% Data Return & Defense
  VS -- Top-K Chunks --> FILTERS
  FILTERS -- Clean Chunks --> PROMPT
  
  %% LLM Generation
  PROMPT --> LLM
  LLM -- Generated Answer --> RAG
  
  %% Output & Logging
  RAG --> REDACT
  REDACT -- Masked Response --> USER
  
  %% Observability Links (Dotted)
  GW -. Correlation ID .-> LOGS
  AUTHZ -. Access Logs .-> LOGS
  REDACT -. Sanitized Data .-> LOGS
  FILTERS -. Threat Intel .-> LOGS
