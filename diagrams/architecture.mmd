%% Secure RAG Pipeline Architecture (Mermaid)
%% NOTE: Replace this file with your final approved diagram if you already have one.

flowchart TD

  %% Styles
  classDef external fill:#f9f9f9,stroke:#333,stroke-width:1px;
  classDef api fill:#e6f3ff,stroke:#0066cc,stroke-width:1px;
  classDef security fill:#fff0e6,stroke:#ff6600,stroke-width:1px;
  classDef data fill:#e6ffe6,stroke:#009900,stroke-width:1px;
  classDef llm fill:#f2e6ff,stroke:#6600cc,stroke-width:1px;
  classDef obs fill:#fffbe6,stroke:#cccc00,stroke-width:1px;

  subgraph EXT[External Zone - Untrusted]
    direction LR
    USER(["User / Client App"]):::external
    ADMIN(["Admin / Ingest Client"]):::external
  end

  subgraph API_BOUNDARY[API Boundary - FastAPI]
    direction TB
    GW["API Gateway\n/chat | /ingest"]:::api
    AUTH["AuthN/AuthZ\nJWT + tenant enforcement"]:::security
    REDACT["PII/Secrets Redaction\n(before logging & model calls)"]:::security
    FILTERS["Prompt & Chunk Filters\n(injection heuristics)"]:::security
    RAG["RAG Pipeline\nretrieve → filter → cite"]:::api
  end

  subgraph DATA[Data Zone - Tenant Scoped]
    direction TB
    VDB[("Vector Store\n(in-memory MVP / Qdrant optional)")]:::data
    META[("Tenant Metadata\n(doc_id, source, labels)")]:::data
  end

  subgraph LLMZONE[Model Zone]
    direction TB
    LLM["LLM Adapter\n(mock MVP → local/managed)"]:::llm
  end

  subgraph OBS[Observability]
    direction TB
    LOGS["Structured Logs\ncorrelation id, no prompts"]:::obs
    AUDIT["Audit Events\npolicy decisions"]:::obs
  end

  USER --> GW
  ADMIN --> GW

  GW --> AUTH --> REDACT --> FILTERS --> RAG
  RAG --> VDB
  RAG --> META
  RAG --> LLM

  GW --> LOGS
  AUTH --> AUDIT
  FILTERS --> AUDIT

  class USER,ADMIN external
