flowchart LR
  %% Secure RAG Pipeline (MVP) - GitHub Mermaid compatible

  subgraph EXT[External - Untrusted Zone]
    U[User / Client App]
    A[Admin / Ingest Client]
  end

  subgraph API[API Boundary - FastAPI Service]
    GW[API Routes: /chat /ingest /health]
    RID[Correlation ID]
    AUTHN[AuthN: JWT Validation]
    AUTHZ[AuthZ Policy Guard: Tenant + Source Allowlist]
    REDACT[Redaction Layer: PII/Secrets]
    RAG[RAG Orchestrator]
    FILTERS[Content Filters: Injection / Unsafe Chunks]
    PROMPT[Prompt Assembler: Boundaries + Citations]
  end

  subgraph DATA[Data Plane]
    VS[(Vector Store)]
    MS[(Metadata Store: tenant_id, source, labels)]
    DS[Document Store / Blobs - optional]
  end

  subgraph LLM[Model Boundary]
    LLMAPI[LLM Provider / Local LLM Adapter]
  end

  subgraph OBS[Observability]
    LOGS[Structured Logs - Redacted]
    METRICS[Metrics / Traces - optional]
  end

  %% Chat flow
  U -->|POST /chat| GW
  GW --> RID
  GW --> AUTHN --> AUTHZ
  AUTHZ -->|allow| RAG
  AUTHZ -->|deny| U

  RAG -->|tenant-bound query| VS
  RAG --> MS
  RAG -->|optional fetch| DS

  VS -->|top-k chunks| FILTERS
  FILTERS -->|clean chunks| PROMPT
  PROMPT --> LLMAPI -->|answer| RAG
  RAG --> REDACT --> LOGS
  RAG -->|response + citations| U

  %% Ingest flow
  A -->|POST /ingest| GW
  GW --> AUTHN --> AUTHZ
  AUTHZ -->|allow| RAG
  RAG -->|chunk + embed + store| VS
  RAG -->|write metadata| MS
  RAG --> REDACT --> LOGS
  RAG -->|ingest result| A

  %% Observability links
  RID --> LOGS
  FILTERS --> LOGS
  AUTHZ --> LOGS
  LOGS --> METRICS
