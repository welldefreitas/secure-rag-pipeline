%% Secure RAG Pipeline Architecture - Optimized Layout (GitHub compatible)
flowchart TD

  %% Define Styles (GitHub supports classDef, may simplify colors if needed)
  classDef external fill:#f9f9f9,stroke:#333,stroke-width:2px;
  classDef api fill:#e6f3ff,stroke:#0066cc,stroke-width:2px;
  classDef security fill:#fff0e6,stroke:#ff6600,stroke-width:2px;
  classDef data fill:#e6ffe6,stroke:#009900,stroke-width:2px;
  classDef llm fill:#f2e6ff,stroke:#6600cc,stroke-width:2px;
  classDef obs fill:#fffbe6,stroke:#cccc00,stroke-width:2px;

  %% Zones
  subgraph EXT[External Zone - Untrusted]
    USER([User / Client App]):::external
    ADMIN([Admin / Ingest Client]):::external
  end

  subgraph API_BOUNDARY[API Boundary - FastAPI]
    GW[API Gateway Routes\n/chat\n/ingest]:::api

    subgraph SECURITY_GATE[Security Enforcement]
      AUTHN[AuthN: JWT Validation]:::security
      AUTHZ[AuthZ: Tenant Policy Guard]:::security
      REDACT[PII Redactor]:::security
    end

    RAG[RAG Orchestrator]:::api

    subgraph CONTENT_DEFENSE[Content Defense]
      FILTERS[Injection Filters]:::security
      PROMPT[Prompt Assembler\n+ Citations]:::security
    end
  end

  subgraph DATA_PLANE[Data Plane - Isolated]
    VS[(Vector Store\nQdrant)]:::data
    MS[(Metadata Store\nTenant ID / Source)]:::data
  end

  subgraph MODEL[Model Boundary - Secure]
    LLM[[Local LLM Engine]]:::llm
  end

  subgraph OBS[Observability]
    LOGS[Structured Logs\nRedacted]:::obs
  end

  %% --- Relationships and Flow ---

  %% Entry
  USER -- "POST /chat" --> GW
  ADMIN -- "POST /ingest" --> GW

  %% Security chain
  GW --> AUTHN --> AUTHZ
  AUTHZ -- Allow --> RAG
  AUTHZ -- Deny --> USER

  %% Retrieval
  RAG -- "Tenant-bound query" --> VS
  RAG -. "Lookup" .-> MS

  %% Defense
  VS -- "Top-K chunks" --> FILTERS
  FILTERS -- "Clean chunks" --> PROMPT

  %% Generation
  PROMPT --> LLM
  LLM -- "Generated answer" --> RAG

  %% Output + redaction
  RAG --> REDACT
  REDACT -- "Masked response" --> USER

  %% Observability (dotted)
  GW -. "Correlation ID" .-> LOGS
  AUTHZ -. "Access logs" .-> LOGS
  REDACT -. "Sanitized data" .-> LOGS
  FILTERS -. "Threat intel" .-> LOGS
